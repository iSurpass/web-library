<!DOCTYPE html>
<html>

<head>
    <title>xxx电子图书馆系统 - 论坛</title>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">

    <link rel="stylesheet" href="css/bootstrap.min.css">
    <style>
        #content-table tbody tr td:first-child {
            text-align: center;
        }

    </style>
</head>

<body>
    <div class="container">
        <!-- 导航栏 -->
        <nav style="height:60px;line-height:60px;overflow:hidden;border-bottom:1px solid #95B8E7;">
            <div style="float:left;width:300px;text-align:center;height:60px;line-height:60px;">
                <p style="font-size:2rem;font-weight:bolder;">XXX电子图书馆系统 - 读者论坛</p>
            </div>

            <div style="float:right;height:60px;line-height:60px;text-align:right;padding-right:20px;">
                <a href="javascript:open_login_dialog();" id="not-logged">登录</a>
                <span class="hide" id="logged">欢迎你：<span style="font-weight:bold;" id="reader-name"></span>&nbsp;&nbsp;|&nbsp;&nbsp;<a href="#" onclick="logout();">注销</a></span>
            </div>
        </nav>

        <div style="margin:10px auto; width:80%;position:relative;">
            <p style="font-size:1.8rem;font-weight:bold;">标题：<span id="title"></span></p>
            <div>
                <span>发帖人：<span id="author"></span></span>
                <span style="margin-left:50px;">发帖时间：<span id="time" ></span></span>
            </div>
        </div>

        <!-- 主贴区 -->
        <div style="border-top:1px solid #95B8E7;margin:10px auto; width:90%;padding:0 10px;">
            <p style="line-height:2.5rem;" id="content"></p>
        </div>

        <!-- 回帖区 -->
        <div id="answer" style="border-top:1px solid #95B8E7;margin:10px auto 10px; width:90%;">
        </div>

        <!-- 我的回复区 -->
        <div id="my-answer" style="margin:0 auto 20px; width:90%;padding:10px 20px 10px;">
            <p style="font-weight:bold;">我的回复:</p>
            <div>
                <textarea class="form-control" rows="10" id="my-answer-content"></textarea>
            </div>
            <div style="text-align:right;padding:5px 0;">
                <a class="btn btn-primary" onclick="reply_bbs();">回复</a>
            </div>
        </div>
    </div>

    <!-- 登录对话框 -->
    <div class="modal fade" tabindex="-1" id="login-dialog">
        <div class="modal-dialog modal-sm">
            <div class="modal-content">
                <div class="modal-header">
                    <button type="button" class="close" data-dismiss="modal" aria-label="Close"><span aria-hidden="true">&times;</span></button>
                    <h4 class="modal-title">读者登录</h4>
                </div>
                <div class="modal-body" style="padding-bottom:0;">
                    <form>
                        <div class="form-group">
                            <label for="ld-username">用户名</label>
                            <input type="text" class="form-control" id="ld-username" placeholder="输入用户名">
                        </div>
                        <div class="form-group">
                            <label for="ld-passwd">密码</label>
                            <input type="password" class="form-control" id="ld-passwd" placeholder="输入密码">
                        </div>
                        <div class="checkbox">
                            <label>
                                <input type="checkbox"> 记住我
                            </label>
                        </div>
                    </form>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-default" data-dismiss="modal">关闭</button>
                    <button type="button" class="btn btn-primary" onclick="login();">登录</button>
                </div>
            </div>
            <!-- /.modal-content -->
        </div>
        <!-- /.modal-dialog -->
    </div>
    <!-- /.modal -->

    <script src="js/jquery.min.js"></script>
    <script src="js/bootstrap.min.js"></script>
    <script src="js/jquery.md5.js"></script>
    <script>
        $(function() {
            // 获取用户名
            $.ajax({
                url: 'if/is-logged.php',
                type: 'get',
                dataType: 'json',
                success: function(data) {
                    if (data.logged) {
                        $('#not-logged').addClass('hide');
                        $('#logged').removeClass('hide');
                        $('#reader-name').text(data.username);
                    }
                }
            });

            var id = get_id();

            // 获取帖子内容
            $.ajax({
                url: 'if/get-bbs-detail.php',
                type: 'get',
                data: {
                    id: id
                },
                dataType: 'json',
                success: function(data) {
                    $('#title').text(data.title);
                    $('#author').text(data.author);
                    $('#time').text(data.time);
                    $('#content').text(data.content);
                }
            });

            // 获取回帖列表
            load_reply_list(id);
        });

        // 获取本帖子的id
        function get_id() {
            var param = window.location.search;
            return param.substring(param.indexOf('=') + 1);
        }

        // 刷新帖子列表
        function load_reply_list(id) {
            $.ajax({
                url: 'if/list-bbs-reply.php',
                type: 'get',
                data: {
                    id: id
                },
                dataType: 'json',
                success: function(data) {
                    var answer = $('#answer');
                    answer.empty();
                    $(data).each(function(index, obj) {

                        var div = $('<div style="border-bottom:1px solid #95B8E7;padding:10px 20px 0;"> \
                <div> \
                    <span>' + (index + 1) + '楼</span>&nbsp;&nbsp;\
                    <span>回复人：</span>\
                    <span>' + obj.author + '</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;\
                    <span>回复时间：</span>\
                    <span>' + obj.time + '</span>\
                </div> \
                <div> \
                    <p style="line-height:2.5rem;">' + obj.content + '</p> \
                </div>\
            </div>');
                        div.appendTo(answer);
                    });
                }
            });
        }

        // 回帖
        function reply_bbs() {
            $.ajax({
                url: 'if/is-logged.php',
                type: 'get',
                dataType: 'json',
                success: function(data) {
                    if (!data.logged) {
                        alert('必须登录才可回帖');
                    } else {
                        var id = get_id();
                        var content = $('#my-answer-content').val().trim();
                        if (content == '') {
                            alert('不允许回复空内容');
                            return;
                        }

                        if (confirm('是否回帖？')) {
                            $.ajax({
                                url: 'if/reply-bbs.php',
                                type: 'post',
                                data: {
                                    id: id,
                                    content: content
                                },
                                dataType: 'json',
                                success: function(data) {
                                    if (data.status == '回复成功') {
                                        // 刷新帖子列表
                                        load_reply_list(id);
                                    }
                                    alert(data.status);
                                }
                            });
                        }
                    }
                }
            });
        }

        // 打开登录对话框
        function open_login_dialog() {
            var dialog = $('#login-dialog');
            dialog.find('input').val('');
            dialog.modal('show');
        }

        // 登录
        function login() {
            var dialog = $('#login-dialog');
            var username = dialog.find('#ld-username').val().trim();
            if (username == '') {
                alert('用户名为空');
                return;
            }

            var passwd = dialog.find('#ld-passwd').val();
            if (passwd == '') {
                alert('密码为空');
                return;
            }

            $.ajax({
                url: 'if/login.php',
                type: 'post',
                data: {
                    username: username,
                    passwd: $.md5(passwd)
                },
                dataType: 'json',
                success: function(data) {
                    alert(data.status);
                    if (data.status == '登录成功') {
                        // 替换用户名
                        $.ajax({
                            url: 'if/is-logged.php',
                            type: 'get',
                            dataType: 'json',
                            success: function(data) {
                                dialog.modal('hide');
                                $('#reader-name').text(data.username).parent().removeClass('hide').siblings().addClass('hide');
                            }
                        });
                    }
                }
            });
        }

        // 注销
        function logout() {
            if (confirm('是否注销？')) {
                $.ajax({
                    url: 'if/logout.php',
                    type: 'post',
                    dataType: 'json',
                    success: function(data) {
                        alert(data.status);
                        if (data.status == '注销成功') {
                            $('#reader-name').parent().addClass('hide').siblings().removeClass('hide');
                        }
                    }
                });
            }
        }

    </script>
</body>

</html>
